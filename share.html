<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Save to Page Vault</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container mt-4">
        <h2>Save Bookmark</h2>
        <form id="shareForm">
            <div class="mb-3">
                <label for="url" class="form-label">URL</label>
                <input type="url" class="form-control" id="url" required>
            </div>
            <div class="mb-3">
                <label for="title" class="form-label">Title</label>
                <input type="text" class="form-control" id="title" required>
            </div>
            <div class="mb-3">
                <label for="tags" class="form-label">Tags</label>
                <input type="text" class="form-control" id="tags" placeholder="Enter tags separated by commas">
                <div id="tagButtons" class="mt-2"></div>
            </div>
            <button type="submit" class="btn btn-primary">Save</button>
            <button type="button" class="btn btn-secondary" onclick="window.close()">Cancel</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        import { supabase } from './src/lib/supabase.js';

        // Get shared data from URL
        const params = new URLSearchParams(window.location.search);
        const sharedUrl = params.get('link') || params.get('url') || params.get('text') || '';
        const sharedTitle = params.get('title') || '';

        // Set input values
        document.getElementById('url').value = sharedUrl;
        document.getElementById('title').value = sharedTitle || sharedUrl;

        // Selected tags tracking
        const selectedTags = new Set();

        // Load existing tags from Supabase
        async function loadTags() {
            const { data: tags, error } = await supabase
                .from('tags')
                .select('*')
                .order('name');

            if (error) {
                console.error('Error loading tags:', error);
                return;
            }

            const tagButtons = document.getElementById('tagButtons');
            tagButtons.innerHTML = tags.map(tag => `
                <button type="button" class="btn btn-outline-secondary btn-sm m-1 tag-button" 
                        data-tag-id="${tag.id}">
                    ${tag.name}
                </button>
            `).join('');

            // Add click handlers for tag buttons
            tagButtons.querySelectorAll('.tag-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tagId = button.dataset.tagId;
                    if (selectedTags.has(tagId)) {
                        selectedTags.delete(tagId);
                        button.classList.remove('btn-secondary');
                        button.classList.add('btn-outline-secondary');
                    } else {
                        selectedTags.add(tagId);
                        button.classList.remove('btn-outline-secondary');
                        button.classList.add('btn-secondary');
                    }
                });
            });
        }

        // Load tags when page loads
        loadTags();

        // Update form submission to handle tags
        document.getElementById('shareForm').onsubmit = async (e) => {
            e.preventDefault();
            
            // Insert the bookmark
            const { data: bookmarkData, error: bookmarkError } = await supabase
                .from('bookmarks')
                .insert([{
                    title: document.getElementById('title').value,
                    url: document.getElementById('url').value
                }])
                .select();

            if (bookmarkError) {
                alert('Error adding bookmark: ' + bookmarkError.message);
                return;
            }

            const bookmarkId = bookmarkData[0].id;

            // Create folder relationships for selected tags
            for (const tagId of selectedTags) {
                const { error: folderError } = await supabase
                    .from('folders')
                    .insert([{
                        bookmark_id: bookmarkId,
                        tag_id: tagId
                    }]);

                if (folderError) {
                    console.error('Error creating folder relationship:', folderError);
                }
            }

            window.close();
            // Fallback if window.close() doesn't work
            window.location.href = './';
        };
    </script>
</body>
</html>
